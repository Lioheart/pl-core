name: Release Creation

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      # Detect v13 or v14 branch based on tag prefix
      - name: Detect FVTT branch
        id: detect_branch
        run: |
          TAG="${{ github.event.release.tag_name }}"

          if [[ "$TAG" == v13* ]]; then
            echo "branch=v13" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == v14* ]]; then
            echo "branch=v14" >> $GITHUB_OUTPUT
          else
            echo "ERROR: tag must start with v13 or v14"
            exit 1
          fi

      # Update module.json with version, manifest and download pointing to THIS release
      - name: Populate Versioned keys in Manifest
        id: sub_manifest
        uses: microsoft/variable-substitution@v1
        with:
          files: 'module.json'
        env:
          version: ${{ github.event.release.tag_name }}
          url: https://github.com/${{ github.repository }}
          manifest: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/module.json
          download: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/module.zip

      # ðŸŸ¦ Move tours/pl â†’ tours/ and delete pl folder
      - name: Flatten tours/pl directory
        run: |
          if [ -d "tours/pl" ]; then
            echo "Moving files from tours/pl/ â†’ tours/"
            mv tours/pl/* tours/ || true
            echo "Removing tours/pl"
            rm -rf tours/pl
          else
            echo "No tours/pl directory found â€” skipping"
          fi

      # ðŸŸ¦ Create ZIP using your folder list
      - name: Create Module Archive
        run: |
          zip --recurse-paths ./module.zip \
            module.json lang/ scripts/ styles/ tours/

      # Upload assets to the release
      - name: Update Release with Files
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          name: ${{ github.event.release.name }}
          draft: ${{ github.event.release.draft }}
          prerelease: ${{ github.event.release.prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "./module.json, ./module.zip"
          tag: ${{ github.event.release.tag_name }}
          body: ${{ github.event.release.body }}
